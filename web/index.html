<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FCE Web Trigger</title>
  <style>
    :root{
      --bg: #0b0d10; /* dark slate */
      --card: #12161b;
      --muted: #8a97a7;
      --text: #e7eef7;
      --accent: #6ea8fe;
      --ok: #37d39b;
      --warn: #f5c84b;
      --err: #ff6b6b;
      --ring: rgba(110,168,254,.35);
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0d10 0%, #0e1217 40%, #0b0d10 100%);color:var(--text);font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:980px;margin:auto;padding:24px}
    .app{display:grid;gap:18px}
    header{display:flex;align-items:center;gap:14px}
    header .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:radial-gradient(120% 120% at 30% 20%, #1c2330, #0e1217);box-shadow:inset 0 0 0 1px #243043}
    header h1{margin:0;font-size:clamp(18px,3.2vw,26px);letter-spacing:.5px}

    .card{background:linear-gradient(180deg,#12161b,#0f1318);border:1px solid #1e2735;border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel{padding:18px}

    form{display:grid;gap:14px}
    .row{display:grid;gap:10px}
    @media (min-width:720px){.row{grid-template-columns:1fr 1fr;gap:12px}}

    label{font-size:12px;letter-spacing:.3px;color:var(--muted)}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #263243;background:#0d1116;color:var(--text);outline:none;transition:.2s box-shadow,.2s border-color}
    input::placeholder{color:#5f6a79}
    input:focus{border-color:#34507a;box-shadow:0 0 0 6px var(--ring)}

    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:14px;padding:12px 16px;background:linear-gradient(180deg,#6ea8fe,#4b79d3);color:white;font-weight:600;letter-spacing:.2px;cursor:pointer;box-shadow:0 6px 16px rgba(78,127,208,.35);transition:transform .06s ease, filter .2s ease}
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    button[disabled]{opacity:.6;cursor:not-allowed;filter:grayscale(.3)}

    .hint{font-size:12px;color:var(--muted)}

    .log{background:#0a0e13;border-top:1px solid #1a2331;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius);max-height:42vh;overflow:auto}
    .log pre{margin:0;padding:14px 16px;white-space:pre-wrap;word-break:break-word;font: 12.5px/1.55 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .line{display:flex;gap:8px;align-items:flex-start}
    .ts{opacity:.45}
    .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid #253044;background:#0d131a;color:#b9c6d6}
    .badge.ok{border-color:#1b3b30;color:#aef3d9;background:rgba(55,211,155,.08)}
    .badge.err{border-color:#46262b;color:#ffb7b7;background:rgba(255,107,107,.08)}
    .badge.warn{border-color:#3e341f;color:#ffe39a;background:rgba(245,200,75,.08)}

    .steps{display:grid;gap:10px;padding:16px}
    .step{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;border:1px solid #1e2735;background:#0c1117;border-radius:14px;padding:10px 12px}
    .step .name{font-weight:600}
    .step .status{font-size:12px;color:#9cb1cc}
    .dot{width:10px;height:10px;border-radius:50%;background:#2b384b;box-shadow:0 0 0 2px #1c2636 inset}
    .dot.spin{position:relative}
    .dot.spin:after{content:"";position:absolute;inset:-4px;border-radius:50%;border:2px solid transparent;border-top-color:var(--accent);animation:spin 1s linear infinite}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--err)}

    @keyframes spin{to{transform:rotate(360deg)}}

    .footer{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;padding:14px 16px;border-top:1px solid #1a2331;color:var(--muted);font-size:12px}
    a{color:#9ec5ff;text-decoration:none}
    a:hover{text-decoration:underline}
    .out{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">
      <header>
        <div class="logo" aria-hidden="true">⚙️</div>
        <h1>FCE Web Trigger</h1>
      </header>

      <section class="card">
        <div class="panel">
          <form id="fceForm">
            <div class="row">
              <div>
                <label for="url">ROM URL</label>
                <input id="url" name="url" type="url" required placeholder="https://example.com/rom.zip" />
              </div>
              <div>
                <label for="file">File name</label>
                <input id="file" name="file" required placeholder="boot" />
              </div>
            </div>
            <div class="actions">
              <button id="startBtn" type="submit">Start</button>
              <span id="statusBadge" class="badge">Idle</span>
            </div>
          </form>
        </div>
        <div class="steps" id="steps"></div>
        <div class="log" id="log"><pre id="logPre"></pre></div>
        <div class="footer">
          <div>Output link (7 days): <span class="out" id="outWrap"><em>—</em></span></div>
          <div>Made for GitHub Pages • Single-file app</div>
        </div>
      </section>
    </div>
  </div>

<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const logPre = $('#logPre');
  const stepsEl = $('#steps');
  const badge = $('#statusBadge');
  const outWrap = $('#outWrap');
  const startBtn = $('#startBtn');
  const proxyEndpoint = 'https://fce-proxy.vercel.app/api/trigger';

  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  const nowTs = ()=> new Date().toLocaleTimeString();
  function log(msg, type){
    const tag = type==='ok'? '✅' : type==='err'? '❌' : type==='warn'? '⚠️' : '•';
    logPre.textContent += `[${nowTs()}] ${tag} ${msg}\n`;
    logPre.parentElement.scrollTop = logPre.parentElement.scrollHeight;
  }
  function setBadge(text, cls){
    badge.textContent = text;
    badge.className = `badge ${cls||''}`.trim();
  }

  function makeStep(name){
    const el = document.createElement('div');
    el.className = 'step';
    el.innerHTML = `<div class="dot" aria-hidden="true"></div><div class="name"></div><div class="status"></div>`;
    $('.name', el).textContent = name;
    $('.status', el).textContent = 'pending';
    stepsEl.appendChild(el);
    return el;
  }
  function setStep(el, status, conclusion){
    const dot = $('.dot', el);
    const statEl = $('.status', el);
    if(status==='in_progress'){
      statEl.textContent = 'in progress…';
      dot.className = 'dot spin';
    } else if(status==='completed'){
      if(conclusion==='success'){
        statEl.textContent = 'done';
        dot.className = 'dot ok';
      } else {
        statEl.textContent = conclusion || 'failed';
        dot.className = 'dot err';
      }
    } else {
      statEl.textContent = status || 'pending';
    }
  }

  function createUniqueId(url, file){
    try{
      const b = url.split('/').pop() || '';
      const nameOnly = (b.split('?')[0]||'').split('.').slice(0,-1).join('.') || b.split('?')[0] || 'file';
      return `${file}_${nameOnly}`;
    }catch{ return `${file}_${Date.now()}` }
  }

  async function callProxy(body){
    const res = await fetch(proxyEndpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
    });
    const data = await res.json();
    if(!res.ok || data.ok === false){
        const errorMsg = data.error || `HTTP Error ${res.status}`;
        const err = new Error(errorMsg);
        err.status = res.status;
        throw err;
    }
    return data;
  }

  async function triggerWorkflow({url, file, uniqueId}){
    log('Triggering workflow…');
    const body = { action: 'trigger', url, file, unique_id: uniqueId };
    await callProxy(body);
    log(`Workflow triggered successfully (ID: ${uniqueId})`, 'ok');
  }

  async function findRunId({uniqueId}){
    log('Looking for matching workflow run…');
    for(let attempt=1; attempt<=60; attempt++) {
      const runsData = await callProxy({ action: 'get_runs' });
      const runs = runsData.workflow_runs || [];
      for(const run of runs){
        const jobsData = await callProxy({ action: 'get_jobs', run_id: run.id });
        if(jobsData && Array.isArray(jobsData.jobs)){
          const match = jobsData.jobs.find(j=> j && j.name === uniqueId);
          if(match){
            log(`Workflow run detected: ID = ${run.id}`, 'ok');
            return run.id;
          }
        }
      }
      log('No workflow runs found yet, waiting…');
      await sleep(5000);
    }
    throw new Error(`No workflow run detected for ${uniqueId}`);
  }

  async function trackRun({runId}){
    let status = 'in_progress';
    const stepMap = new Map();

    while(status !== 'completed'){
      await sleep(3000);
      const run = await callProxy({ action: 'get_run_details', run_id: runId });
      status = run.status;
      const conclusion = run.conclusion;

      const jobsData = await callProxy({ action: 'get_jobs', run_id: runId });
      const job = jobsData.jobs && jobsData.jobs[0];
      if(!job){ log('⌛ Waiting for jobs…'); continue; }

      const jobDetails = await callProxy({ action: 'get_job_details', job_id: job.id });
      const steps = jobDetails.steps || [];
      for(const s of steps){
        if(!stepMap.has(s.name)) stepMap.set(s.name, makeStep(s.name));
        const el = stepMap.get(s.name);
        setStep(el, s.status, s.conclusion);
      }

      if(status === 'completed'){
        log(`Workflow finished with conclusion: ${conclusion}`,(conclusion==='success'?'ok':(conclusion?'err':undefined)));
        return conclusion;
      }
    }
  }

  async function checkOutput({uniqueId, file}){
    const outputUrl = `https://offici5l.github.io/FCE/${encodeURIComponent(uniqueId)}/${encodeURIComponent(file)}.zip`;
    log('Checking if output is available…');

    for(let i=0;i<30;i++){
      try {
        const res = await callProxy({ action: 'check_output', output_url: outputUrl });
        if(res.status === 200){
          log('Output is ready and will be available for 7 days:', 'ok');
          outWrap.innerHTML = `<a href="${outputUrl}" target="_blank" rel="noopener">${outputUrl}</a>`;
          return true;
        }
      } catch(e) { /* ignore */ }
      await sleep(5000);
    }

    log('Output not found yet. You can try the link later.','warn');
    outWrap.innerHTML = `<a href="${outputUrl}" target="_blank" rel="noopener">${outputUrl}</a>`;
    return false;
  }

  $('#fceForm').addEventListener('submit', async (e)=>{
    e.preventDefault();

    // Reset UI
    stepsEl.innerHTML = '';
    logPre.textContent = '';
    outWrap.innerHTML = '<em>—</em>';

    const url = $('#url').value.trim();
    const file = $('#file').value.trim();

    if(!url || !file){
      setBadge('Missing input','err');
      log('Please provide both URL and file name.','err');
      return;
    }

    const uniqueId = createUniqueId(url, file);

    startBtn.disabled = true;
    setBadge('Working…','warn');

    try{
      await triggerWorkflow({url, file, uniqueId});
      const runId = await findRunId({uniqueId});
      const conclusion = await trackRun({runId});
      if(conclusion !== 'success'){
        setBadge('Failed','err');
        await checkOutput({uniqueId, file});
        return;
      }
      setBadge('Success','ok');
      await checkOutput({uniqueId, file});
    } catch (err){
      console.error(err);
      setBadge('Error','err');
      log(`Error: ${err.message || err}`, 'err');
    } finally {
      startBtn.disabled = false;
    }
  });
})();
</script>
</body>
</html>